## IDO 奖池与 ETH 质押（产品设计）

### 背景与目标

- **目标**: 让参与者在加入活动时质押 ETH，形成公共奖池；活动结束时，按各地址持有的 `IDO` 比例分配奖池 ETH，强化 IDO 的用例激励。
- **与现有机制衔接**: 不改变 `IDO/WEDO` 的日常记账与分红；ETH 奖池是“额外的期末奖励”。淘汰规则仍由打卡与团队机制决定（见 `docs/spec.md`）。

### 核心概念

- **质押（Stake）**: 加入活动的入场门槛，锁定至活动结束或退赛（见资格与退出）。
- **奖池（Prize Pool）**: 全体有效质押累计的 ETH（可选含合作赞助），在结算时一次性分配。
- **结算快照（Snapshot）**: 在活动“结束时刻”对 `IDO` 的符合资格持仓进行快照，作为分配基准。
- **资格（Eligibility）**: 是否纳入结算的 `IDO` 与地址范围，见下文“资格与快照”。

### 资金流与公式

1. 质押入池

- 参与者加入活动 → 质押 `depositETH`（默认 0.3 ETH，可配置）。
- 质押直接归集至奖池合约的池余额 `T`，不可取回，直到结算或退赛退款规则触发。

2. 结算分配

- 结算时刻 `t_end` 做一次 `IDO` 余额快照：
  - 记所有符合资格地址的 `IDO` 快照余额之和为 `S`。
  - 某地址 `i` 的快照余额为 `b_i`。
- 分配公式：
  - 地址 `i` 的应得 ETH：\( reward_i = T \times \frac{b_i}{S} \)。
  - 采用“可领取”模型：在链上记录 `reward_i` 为 `claimableETH_i`，用户自助 `claim`。

3. 页面预估（活动进行中）

- 预估奖励（非承诺值）：\( est_reward_i = T\_{now} \times \frac{bal_IDO_i}{S\_{now}} \)，其中 `S_now` 为当前（非快照）符合资格的 `IDO` 总量。
- 明确提示：“最终以结算快照为准，期间 IDO/奖池变化会影响预估值”。

### 资格与快照

- **当前选择**: 幸存者模式（仅未淘汰成员参与分配）

- **默认模式（持币即权益，推荐）**:

  - 结算时刻拥有 `IDO` 的任意地址（无论是否被淘汰）均纳入快照 `S`。
  - 符合现有公平性：被淘汰者既无法继续从团队 `WEDO→IDO` 分红中获益，但其已持有的 `IDO` 仍具有期末 ETH 权益。

- **可选模式（仅幸存者）**:

  - 仅团队“未淘汰成员”的地址进入快照 `S`（由平台配置 `eligibilityAtSettlement = survivorsOnly`）。
  - 页面需明显标注“仅限未淘汰成员分配”。

- **技术要点（不写实现，仅约束）**:
  - 快照基于区块高度或时间戳锁定；
  - 快照后至用户领取前的 `IDO` 流转不影响 `claimableETH`。

### 退出与异常处理

- **主动退赛（冷静期后）**:

  - 可选策略 A：不退还质押，全部留在奖池，维持“退出有成本”。
  - 可选策略 B：退还部分（例如 50%），另一半进入奖池（配置 `refundRateOnQuit`）。

- **被淘汰**:

  - 质押不退还，进入奖池；
  - 若采用“仅幸存者分配”，被淘汰者不参与 ETH 分配；若采用“持币即权益”，则其结算时持有的 `IDO` 仍参与分配。

- **技术失败/回滚**: 若结算执行失败，保留重试与紧急暂停（`paused`）开关；在暂停期间不可新质押与领取。

### 页面与交互（参照线框）

页面：`IDO 奖池`

- **顶部导航**: 左侧“残酷小队”返回入口；右侧“连接钱包”按钮。
- **主视觉区**:

  - 大字显示“当前奖池：{T} ETH”。
  - 说明文案（可编辑）：
    - 奖池来源：成员质押与赞助累计。
    - 参与需质押：默认 0.3 ETH；退出/被淘汰的处理规则。
    - 结算时间：例如 `2025/09/01`。
    - 规则：按结算快照的 `IDO` 权重分配。

- **概览区（两列）**:

  - 左列“总览表”：`地址 | IDO | 预估奖励`（分页，地址做中间打码）。
  - 右列“我的面板”：
    - 我的 `IDO`：`b_me`；
    - 我的预估奖励：`est_reward_me`；
    - CTA：
      - “加入活动并质押”/“追加质押”（可选）/“查看规则”。
      - 结算后显示“领取 ETH”按钮（仅当 `claimableETH_me > 0`）。
    - 提示：结算后在此处出现领取按钮。

- **状态与提示**:
  - 活动进行中：展示预估值与风险提示。
  - 已结算未领取：展示“你可领取 X.XXX ETH”。
  - 已领取：展示“已领取，交易哈希”。

### 用户旅程

1. 加入并质押

- 连接钱包 → 点击“加入活动并质押” → 输入或确认默认质押额 → 成功后更新奖池与“我的面板”。

2. 参与日常活动

- 与现有系统一致：完成任务获得 `IDO`，团队 `WEDO` 记账与分红不变。

3. 结算与领取

- 到达 `t_end` → 平台触发“结算快照与分配” → 页面显示个人可领取 `ETH` → 用户点击“领取 ETH”。

### 配置项（平台级）

- `minDepositETH`（默认 0.01 ETH，首次参与通过 `join` 收取）
- `eligibilityAtSettlement`：`allHolders`｜`survivorsOnly`
- `refundRateOnQuit`：退赛退还比例（0–100%）
- `allowExtraSponsors`：是否允许附加赞助资金注入奖池
- `endTimestamp`：结算时间

### 文案范例

- 规则说明（可在页面展示）:
  - “加入活动需质押 {minDeposit} ETH，活动结束按你持有的 IDO 比例分配奖池 ETH。预估值随奖池与 IDO 总量变动而变化，最终以结算快照为准。退出或被淘汰的质押按平台规则处理。”

### 示例（对齐线框）

- 当前奖池：`230 ETH`
- 你持有：`20 IDO`
- 当前全体符合资格 `IDO` 总量：`S_now = 3,800`
- 你的预估奖励：`230 × 20 / 3,800 = 1.2105 ETH`（页面显示约 `1.21 ETH`）
- 结算后，如果 `S_snapshot = 3,650`，你的最终奖励：`230 × 20 / 3,650 = 1.2603 ETH`。

### 指标与风控

- 指标：
  - 奖池规模、参与率（已质押地址数/报名数）、人均质押、领取完成率、平均领取时延。
  - 贡献影响：人均 `IDO` 与人均 ETH 奖励的相关性。
- 风控：
  - 反女巫：最低质押额 + 账号活跃阈值；
  - 反钓鱼：提现白名单/延时领取（可选）；
  - 合规提醒：非证券承诺，纯活动激励。

### 数据与事件（只做约束，不写实现）

- 数据面（链上）：
  - 奖池余额 `T`、活动状态 `status`、快照参数（快照区块/时间、`S`、`T_at_snapshot`）；
  - 地址维度的 `claimableETH`、是否已领取标记。
- 事件面：
  - `Staked(address, amount)`、`Sponsored(address, amount)`、`SnapshotTaken(block, S, T)`、`Claimed(address, amount)`、`Quit(address, refunded)`。

### 与团队榜单的关系

- IDO 奖池分配与“团队内 `WEDO→IDO` 均分”互不冲突：
  - 日常：团队活跃提高 `IDO` 获得速度；
  - 期末：更高 `IDO` 持仓获得更大 ETH 份额；
  - 排行展示：保留“人均分红”“当前 L 与团队总分”等指标，新增“期末 ETH 奖励预估/实际”。

### 上线节奏（MVP）

1. MVP：固定质押额 + 全持有者参与分配 + 单次快照 + 可领取模型。
2. v2：支持仅幸存者模式、可配置退还比例、赞助入口、追加质押。
3. v3：多阶段奖池（周/月结）、多次快照合并、二级市场/回购玩法。
