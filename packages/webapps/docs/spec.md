# 残酷学分！为了部落！

我们在做什么（一句话）
**残酷学分**：把“残酷共学”的活动积分上链，做成有团队协作增益与退出惩罚的游戏化积分系统。

### 核心要点

- **打卡用途**: 仅用于判定是否淘汰（当周缺勤>2 次淘汰），不直接给分。
- **积分来源**: 学员提交“完成学习任务”获取 **$STORY** 积分，不同活动有不同基础分 $p$ ，例如分享自己学习笔记有 40 分，参加一次晚会有 5 分等等。
- **发行方式**：学员在 Tally 表单自主提交学习记录 -> Webhook 发送请求到服务器 -> 服务器用私钥调用合约`mint`对应 $STORY 代币到用户个人钱包及团队共享金库。
- **分配机制**: 个人拿 $p×α$（默认 0.8），团队池拿 $p×(1−α)×L(R)$。
- **团队增益 $L(R)$**: 只由“$当前在籍人数 R/初始人数 N0$”决定（线性或阶梯），队满增益最高，成员退出则下降。
- **退出惩罚**: 退出者“未领取的个人积分”销毁；其“未领取的团队份额”进入再分配池，在下次结算时均分给在籍成员。
- **结算与领取**: 到固定结算时点（建议每周），在籍成员按规则领取主团队池（按个人贡献占比分配）+ 退出再分配池（均分）。
- **公平与竞争**: 限制团队人数上限（建议 6），主榜看“人均分红”，辅榜看“当前 L 和团队总分”。
- **产品体验**: 圆桌式团队可视化、活动流、可领取弹窗；可选上链（ERC20 + Merkle Claim）低成本发放。

### 经济规则

- **团队规模上限**：6（建议 4–6），初始编制记为 $N_0$，当前在籍（未淘汰）人数为 $R$。
- **活动积分（审核通过即结算）**：
  - 个人：$p \times \alpha$（建议 $\alpha=0.8$）
  - 团队池：$p \times (1-\alpha) \times L(R)$
- **倍数$L(R)$仅由“当前剩余人数”决定**（两种等价表现，选其一即可）：
  - 线性版（推荐，最简）：$L(R)=L_{min} + (L_{max}-L_{min}) \times \frac{R}{N_0}$  
    建议：$L_{min}=1.0,\ L_{max}=1.5$。每少一人，惩罚为固定 $\frac{L_{max}-L_{min}}{N_0}$，对大队更温和，公平。
  - 阶梯版（更直观，便于宣讲）：满编 1.5；少 1 人 1.4；少 2 人 1.3；…直至 1.0。
- **淘汰与资格**：打卡仅决定是否淘汰（例如一周缺勤>2 则淘汰），淘汰即时减少 $R$ 并失去分红资格；新加入可设 24–72h 冷静期后计入 $R$（防刷）。
- **分红结算**：在你设定的结算时点（天/周/月均可，与规则独立），未淘汰成员参与，按“结算期内个人活动分占比”瓜分团队池。
- **排行榜（凸显凝聚与竞争）**：
  - 主榜：人均分红排行（规模无关，更公平）
  - **辅榜：当前 $L(R)$ 排名、团队总分/人均总分**

例子：$N_0=6$，当前 $R=5$ → 线性版 $L=1.0+(1.5-1.0)\times 5/6=1.4167$。  
成员提交活动 $p=20$：个人得 16；团队池 + $20\times 0.2\times 1.4167=5.667$。

### 退出处理（可选：落叶归根）

针对成员被残酷淘汰，团队分红池的再分配机制：

- 个人未领取积分：100% 销毁（可配 0–100%，默认 100%）
- 个人未领取的团队分红份额：全部进入“退出再分配池”，在下一次结算时“均分”给当时仍在籍成员
  结算顺序：先分主团队池（按个人当周活动分占比），再均分退出再分配池

### 上链与成本（务实落地）

- 链选型：直接用 L2 测试网（Base Sepolia）演示。
- 交互成本：不要每次打卡都上链。采用“周度结算 + Merkle Claim”模式：
  - 每天打卡与团队池分摊先在后端/数据库记账。
  - 每周计算各成员应得的分红，生成 Merkle Root 上链。
  - 前端用 proof 让用户一键 Claim（极低 gas，体验好）。
- 代币模型：
  - MVP 用可转移 ERC20（OpenZeppelin），便于展示余额与排行榜。
  - 如果担心投机，可后续引入“不可转移积分 + 可转移治理/纪念凭证”的双代币架构（迭代再做）。

### 智能合约最小集合（MVP）

- PointsToken（ERC20）
  - `mint(to, amount)` 受 AccessControl 限制，仅结算合约/owner 可调用。
- TeamManager
  - `createTeam(flagURI, initialL)`
  - `join(teamId)` / `eliminate(whom)`（更新 $L$、写入事件）
  - 只保留最必要的队伍与成员关系；$L$ 的调整事件化，方便前端展示。
- WeeklyDistributor（Merkle 分发，暂时不用，如果想做 Merkle，可以对团队部分用 Merkle 来分发）
  - `setRoot(epoch, root)` 仅 owner
  - `claim(epoch, index, account, amount, proof)`
  - `evict`
  - 事件：`Claimed(epoch, account, amount)` 供前端/子图展示

说明：日常“打卡积分计算、团队池内部分配权重”全部由后端计算，合约仅做“最终可验证的结算发放”。

### 后端与防作弊

- 扫链缓存各种事件，方便前端显示。
- 数据来源：MVP 先支持“人工打卡 + 轻量证明”（截图/地理位置/打卡任务链接），管理员抽查；Hackathon 重点是机制演示。
- 防刷建议：（不需要）
  - 限制每日打卡上限与最小间隔。
  - 活跃天数门槛参与分红（见上）。
  - 行为分析：同 IP/同设备多号、极端节律等简单阈值拦截。
  - 后续可对接 GitHub/GFit/Apple Health/Notion 等真实数据源。

### UI/交互建议（高可玩且易实现）

- 圆桌总览（一个页面放多个小组）：
  - 中心：队旗、团队名、当前 L；旁边展示“本周团队池总量、已分发、未认领”。
  - 周围：成员头像环形排布。悬停显示“本周贡献、可领取分红、最近打卡时间”。
- 右侧活动流：
  - “谁在什么时候获得了多少积分”“当前 L 变化（有人退出/加入）”“本周分红 Top 3”。
- 领奖入口：
  - 顶部“本周可领取 X 代币”，点击弹出 Claim 面板（展示 Merkle 详情+交易 Hash）。
- 细节动效：
  - 成员打卡时，中心冒出粒子飞向该成员与团队池，传达“L 倍 + 分红”的心智。

### 路线图（Hackathon 三步走）

- Day 1：定参数（$L$、$α$、活跃阈值）、完成 UI 原型、做本地记账和活动流。
- Day 2：实现周度分红计算与 Merkle 生成、部署测试网合约、（前端完成 Claim）。
- Day 3：打磨可视化、加退出降杠杆、加入最小防刷规则、准备 Demo 数据与讲解脚本。

### 关键指标（Demo 展示用）

- 团队留存率、成员活跃率（7 日内打卡 ≥ N 的比例）
- 团队池分红参与率、平均领取时延
- 单人贡献带动的“团队新增积分倍数”（p→p×L 的直观图）
- 退出事件对 L 的影响与团队活跃的联动图

# 前端展示文案（可直接用）

- 顶部信息区（圆桌中心）

  - 标题：团队「{teamName}」
  - 副标题：当前在籍 {R}/{N0}｜团队增益 L={L}
  - 说明：活动积分按“个人 80% + 团队池 20%×$L(R)$”结算；$L(R)$仅由在籍人数决定

- 成员头像悬浮卡片

  - 名称：{memberName}
  - 个人积累：{personalPoints} 分（可领取 {claimablePersonal}）
  - 团队分红（主池）：预计 {expectedTeamShareMain}
  - 退出再分配（均分）：预计 {expectedExitPoolShare}
  - 最近活动：{lastActivityName} +{p} 分
  - 状态：{statusTag}（在籍/淘汰/冷却中）

- 活动流（时间线）

  - {time} {memberName} 完成「{activityName}」，个人 +{p×0.8}，团队池 +{p×0.2×L}（L={L}，在籍 {R}/{N0}）
  - {time} {memberName} 退出，未领取个人积分已销毁，团队份额将于下次结算均分给在籍成员
  - {time} 在籍人数变化：{prevR} → {R}，L：{prevL} → {L}
  - {time} 结算完成：主池按贡献分配，退出再分配池已均分

- 侧栏统计卡片

  - 团队池（待分配）：{teamPoolPending} 分
  - 退出再分配池：{exitPoolPending} 分（下次均分）
  - 本周在籍成员：{R} 人
  - 人均预估分红：{avgProjected} 分

- 结算/领取弹窗

  - 标题：领取分红
  - 你的分配：
    - 主池（按个人贡献）：{mainShare} 分
    - 退出再分配（均分）：{exitShare} 分
  - 合计：{totalClaim} 分
  - 按钮：领取到我的账户

- 退出确认弹窗

  - 标题：确认退出团队？
  - 提示：你未领取的个人积分将被销毁，你的团队分红份额将被均分给剩余成员。
  - 次要提示：退出后 {rejoinCooldownHours} 小时内不可加入任何团队。
  - 按钮：确认退出 / 取消

- 加入受限提示

  - 团队已满：该团队已满员（{N0}/{N0}），请选择其他团队
  - 冷却中：你仍在冷却期（剩余 {hoursLeft} 小时），暂不可加入新团队

- 空状态与异常

  - 暂无活动记录：完成一项活动以点亮团队环
  - 无在籍成员：团队待重建，当前 L=1.0
  - 你已淘汰：当周缺勤已超过 2 次，暂不参与分红

- 排行卡片（切换主/副榜）
  - 主榜：人均分红排行（更公平）
  - 副榜：当前 L 排行｜团队总分排行

---
